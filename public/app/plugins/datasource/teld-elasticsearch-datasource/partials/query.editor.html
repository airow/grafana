<query-editor-row query-ctrl="ctrl" can-collapse="true">

	<div class="gf-form-inline">
		<div class="gf-form gf-form--grow">
			<label class="gf-form-label query-keyword width-7">Query</label>
			<input type="text" class="gf-form-input" ng-model="ctrl.target.query" spellcheck='false' placeholder="Lucene query" ng-blur="ctrl.refresh()">
		</div>
		<div class="gf-form max-width-15">
			<label class="gf-form-label query-keyword">Alias</label>
			<input type="text" class="gf-form-input" ng-model="ctrl.target.alias" spellcheck='false' placeholder="alias patterns" ng-blur="ctrl.refresh()">
		</div>
	</div>

	<div ng-repeat="agg in ctrl.target.metrics">
		<elastic-metric-agg
			target="ctrl.target" index="$index"
			get-fields="ctrl.getFields($fieldType)"
      on-change="ctrl.queryUpdated()"
      on-addscriptfield="ctrl.addScriptField()"
			es-version="ctrl.esVersion">
		</elastic-metric-agg>
	</div>

	<div ng-repeat="agg in ctrl.target.bucketAggs">
		<elastic-bucket-agg
			target="ctrl.target" index="$index"
      get-fields="ctrl.getFields($fieldType)"
			on-change="ctrl.queryUpdated()">
		</elastic-bucket-agg>
	</div>

  <div ng-if='ctrl.isRawDocument()' ng-repeat="agg in ctrl.target.scriptFieldsConf">
    <elastic-script-fields target="ctrl.target" index="$index"
      on-addscriptfield="ctrl.addScriptField()"
      on-change="ctrl.queryUpdated()">
    </elastic-script-fields>
  </div>

  <!-- <elastic-script-fields target="ctrl.target" on-change="ctrl.queryUpdated()">
  </elastic-script-fields> -->

  <div class="gf-form-inline">
    <div class="gf-form">
      <label class="gf-form-label query-keyword width-9">
        Time range
      </label>
    </div>
    <gf-form-switch class="gf-form" label="忽略dash时间" label-class="width-8" checked="ctrl.target.ignoreTimeRange">
    </gf-form-switch>
    <gf-form-switch class="gf-form"
      label="Override" label-class=""
      checked="ctrl.target.timeRange.enable" switch-class="max-width-6" on-change="ctrl.refresh()">
    </gf-form-switch>
    <div class="gf-form" ng-show="ctrl.target.timeRange.enable">
      <span class="gf-form-label width-12">Override relative time</span>
      <span class="gf-form-label width-6">Last</span>

      <input type="text" class="gf-form-input max-width-8" placeholder="1h"
        empty-to-null ng-model="ctrl.target.timeRange.timeFrom" valid-time-span
        ng-change="ctrl.refresh()" ng-model-onblur></input>
    </div>

    <div class="gf-form" ng-show="ctrl.target.timeRange.enable">
      <span class="gf-form-label width-12">Add time shift</span>
      <span class="gf-form-label width-6">Amount</span>
      <input type="text" class="gf-form-input max-width-8" placeholder="1h"
        empty-to-null ng-model="ctrl.target.timeRange.timeShift" valid-time-span
        ng-change="ctrl.refresh()" ng-model-onblur></input>
    </div>
  </div>
  <div class="gf-form-inline">
    <div class="gf-form">
      <label class="gf-form-label query-keyword width-9">数据权限</label>
    </div>
    <div class="gf-form">
      <label class="gf-form-label query-keyword width-9">字段</label>
      <label class="gf-form-label query-keyword width-10">授权对象</label>
    </div>
    <div class="gf-form">
      <label class="gf-form-label">
        <a ng-click="ctrl.target.dataPermission.push({field:'select field',values:['']})">
          <i class="fa fa-plus"></i>
        </a>
      </label>
    </div>
  </div>
  <div class="gf-form-inline" ng-repeat="permission in ctrl.target.dataPermission">
    <div class="gf-form offset-width-9">
      <metric-segment-model property="permission.field" get-options="ctrl.getFields()" on-change="onChange()" css-class="width-9"></metric-segment-model>
    </div>
    <div class="gf-form" ng-repeat="value in permission.values track by $index">
      <input type="text" class="gf-form-input width-10" min-length="0" bs-typeahead='ctrl.getPermissionOptionsPromise'
       ng-model="permission.values[$index]" ng-change="ctrl.refresh()" ng-model-onblur></input>
      <label class="gf-form-label">
        <a ng-click="permission.values.splice($index,1)">
          <i class="query-keyword fa fa-remove"></i>
        </a>
      </label>
    </div>
    <div class="gf-form">
      <label class="gf-form-label">
        <a ng-click="permission.values.push('')">
          <i class="query-keyword fa fa-plus"></i>
        </a>
      </label>
    </div>
    <div class="gf-form">
      <label class="gf-form-label">
        <a ng-click="ctrl.removeItem(ctrl.target.dataPermission, permission)">
          <i class="pointer fa fa-trash"></i>
        </a>
      </label>
      <label class="gf-form-label" ng-hide="$last">
        <a ng-click="ctrl.moveItem(ctrl.target.dataPermission,$index,$index+1)">
          <i class="pointer fa fa-arrow-down"></i>
        </a>
      </label>
      <label class="gf-form-label" ng-hide="$first">
        <a ng-click="ctrl.moveItem(ctrl.target.dataPermission,$index,$index-1)">
          <i class="pointer fa fa-arrow-up"></i>
        </a>
      </label>
    </div>
  </div>
</query-editor-row>
